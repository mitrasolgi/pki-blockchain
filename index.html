<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Authority</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js"></script> <!-- Include Forge.js -->

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Blockchain-based PKI Management</h1>
    <div>
        <h2>Issue Certificate</h2>
        <input type="text" id="issueAddress" placeholder="Ethereum Address" />
        <button id="issueBtn">Issue Certificate</button>
        <div id="issueAlert"></div>
    </div>
    <!-- <div>
        <h2>Verify Certificate</h2>
        <input type="text" id="verifyAddress" placeholder="Ethereum Address" />
        <button id="verifyBtn">Verify Certificate</button>
        <div id="verifyAlert"></div>
    </div> -->
    <div>
        <h2>Revoke Certificate</h2>
        <input type="text" id="revokeAddress" placeholder="Ethereum Address" />
        <button id="revokeBtn">Revoke Certificate</button>
        <div id="revokeAlert"></div>
    </div>

    <div>
        <h2>Generated Certificate</h2>
        <pre id="certificateDisplay"></pre> <!-- Area to display the certificate -->
    </div>

    <script>
// Generate an X.509 certificate
function generateCertificate(userAddress) {
            const keys = forge.pki.rsa.generateKeyPair(2048); // Generate RSA key pair
            const cert = forge.pki.createCertificate();
            cert.publicKey = keys.publicKey;
            cert.serialNumber = '01';
            cert.validFrom = new Date().toISOString(); // Set validFrom to now
            cert.validTo = new Date();
            cert.validTo.setFullYear(cert.validTo.getFullYear() + 1); // Valid for 1 year
            cert.setSubject([{ name: 'commonName', value: userAddress }]); // Set the subject
            cert.setIssuer([{ name: 'commonName', value: 'Certificate Authority' }]); // Set the issuer
            cert.sign(keys.privateKey, forge.md.sha256.create()); // Sign the certificate

            // Convert the certificate to PEM format
            const certPem = forge.pki.certificateToPem(cert);
            return certPem; // Return the PEM formatted certificate
        }

        // Handle the Issue Certificate button click
        $('#issueBtn').click(function() {
    const userAddress = $('#issueAddress').val(); // Get the Ethereum address from input
    const certPem = generateCertificate(userAddress); // Generate the certificate in PEM format
    
    // Display the generated certificate
    $('#certificateDisplay').text(certPem);

    // Send the certificate data to the blockchain
    $.post('/issue-certificate', { userAddress, certPem })
        .done(function(data) {
            $('#issueAlert').html(`<span style="color: green;">${data.message}</span>`);
        })
        .fail(function(jqXHR) {
            $('#issueAlert').html(`<span style="color: red;">${jqXHR.responseJSON.error}</span>`);
        });
});

$('#revokeBtn').click(function() {
    const userAddress = $('#revokeAddress').val();
    $.post('/revoke-certificate', { userAddress })
        .done(function(data) {
            $('#revokeAlert').html(`<span style="color: green;">${data.message}</span>`); // Use backticks
        })
        .fail(function(jqXHR) {
            $('#revokeAlert').html(`<span style="color: red;">${jqXHR.responseJSON.error}</span>`); // Use backticks
        });
});

$('#verifyBtn').click(function() {
    const userAddress = $('#verifyAddress').val();
    $.post('/verify-certificate', { userAddress })
        .done(function(data) {
            $('#verifyAlert').html(`<span style="color: green;">Certificate is valid: ${data.isValid}</span>`); // Use backticks
        })
        .fail(function(jqXHR) {
            $('#verifyAlert').html(`<span style="color: red;">${jqXHR.responseJSON.error}</span>`); // Use backticks
        });
});

    </script>
</body>
</html>